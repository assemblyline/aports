# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Ed Robinson <ed@reevoo.com>
pkgname=nodejs
pkgver=7.4.0
pkgrel=101
pkgdesc="JavaScript runtime built on V8 engine - current stable version"
url="http://nodejs.org/"
arch="all"
license="MIT"
depends="ca-certificates"
depends_dev="libuv"
# gold is needed for mksnapshot
makedepends="$depends_dev python2 openssl-dev zlib-dev libuv-dev linux-headers
  paxmark binutils-gold http-parser-dev ca-certificates"
subpackages="$pkgname-dev $pkgname-doc"
replaces="nodejs nodejs-lts"  # nodejs-lts for backward compatibility
source="https://nodejs.org/dist/v$pkgver/node-v$pkgver.tar.gz
  use-system-ca-certs.patch"
builddir="$srcdir/node-v$pkgver"

prepare() {
  default_prepare || return 1

  # Remove bundled CA certificates.
  rm -f src/node_root_certs.h
}

build() {
  cd "$builddir"

  ./configure --prefix=/usr \
    --shared-zlib \
    --shared-libuv \
    --shared-openssl \
    --shared-http-parser \
    || return 1

  # we need run mksnapshot at build time so paxmark it early
  make -C out mksnapshot BUILDTYPE=Release \
    && paxmark -m out/Release/mksnapshot \
    && make || return 1
  make test || return 1
}

package() {
  cd "$builddir"

  make DESTDIR="$pkgdir" install || return 1
  # paxmark so JIT works
  paxmark -m "$pkgdir"/usr/bin/node || return 1

  cp -pr "$pkgdir"/usr/lib/node_modules/npm/man "$pkgdir"/usr/share || return 1
  local d; for d in doc html man; do
    rm -r "$pkgdir"/usr/lib/node_modules/npm/$d || return 1
  done
}

md5sums="9732aba61759bc97d2bb2e7d82453f83  node-v7.4.0.tar.gz
391dadece3caea603003e022d90ba87b  use-system-ca-certs.patch"
sha256sums="69b76c86e6fc9914fa136089d8c28a4828c14aa8792cbdf946090a5a2afd25b6  node-v7.4.0.tar.gz
dad9470333c07df46bcb46823ce6bf6d606b4146cf9996ef847c458befde8219  use-system-ca-certs.patch"
sha512sums="2f69502430d3940b711ef46d7b400b5983234c47114e1729fe94c5b81bd4ea78917c2dba755bc6e6343a788b95553b9a39ae778daa9903407bf76caa07d82f85  node-v7.4.0.tar.gz
5c2c4863d5b38ca0bbd81aa8ff5e721cfd3d8c07fef463e34324c5dbd2d15a0d4d966084629c196f94b10c7e17c5527c3eb490c0789b07f1edff013812957a22  use-system-ca-certs.patch"
