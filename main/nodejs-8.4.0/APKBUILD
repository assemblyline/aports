# Contributor: William Pitcock <nenolod@dereferenced.org>
# Contributor: Jose-Luis Rivas <ghostbar@riseup.net>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Contributor: Dave Esaias <dave@containership.io>
# Contributor: Tadahisa Kamijo <kamijin@live.jp>
# Maintainer: Ed Robinson <ed@reevoo.com>
_name=nodejs
pkgver=8.4.0
pkgname="$_name$pkgver"
pkgrel=0
pkgdesc="JavaScript runtime built on V8 engine - current stable version"
url="http://nodejs.org/"
arch="all"
license="MIT"
depends="ca-certificates"
depends_dev="libuv"
# gold is needed for mksnapshot
makedepends="$depends_dev $depends_dev python2 openssl-dev zlib-dev libuv-dev linux-headers
  paxmark binutils-gold http-parser-dev ca-certificates c-ares-dev"
subpackages="$pkgname-dev $pkgname-doc $pkgname-npm::noarch"
provides="nodejs"
replaces="nodejs nodejs-current"
source="https://nodejs.org/dist/v$pkgver/node-v$pkgver.tar.gz
  dont-run-gyp-files-for-bundled-deps.patch"
builddir="$srcdir/node-v$pkgver"

prepare() {
  default_prepare || return 1

  # Remove bundled dependencies that we're not using.
  rm -rf deps/http_parser deps/openssl deps/uv deps/zlib
}

build() {
  cd "$builddir"

  ./configure --prefix=/usr \
    --shared-zlib \
    --shared-libuv \
    --shared-openssl \
    --shared-http-parser \
    --shared-cares \
    --openssl-use-def-ca-store \
    || return 1

  # we need run mksnapshot at build time so paxmark it early
  make -C out mksnapshot BUILDTYPE=Release \
    && paxmark -m out/Release/mksnapshot \
    && make || return 1
}

package() {
  cd "$builddir"

  make DESTDIR="$pkgdir" install || return 1
  # paxmark so JIT works
  paxmark -m "$pkgdir"/usr/bin/node || return 1

  cp -pr "$pkgdir"/usr/lib/node_modules/npm/man "$pkgdir"/usr/share || return 1
  local d; for d in doc html man; do
    rm -r "$pkgdir"/usr/lib/node_modules/npm/$d || return 1
  done
}

npm() {
        pkgdesc="a JavaScript package manager"
        depends="$pkgname"
        mkdir -p "$subpkgdir"/usr/bin
        mv "$pkgdir"/usr/bin/npm "$subpkgdir"/usr/bin/npm
        mkdir -p "$subpkgdir"/usr/lib/node_modules
        mv "$pkgdir"/usr/lib/node_modules/npm "$subpkgdir"/usr/lib/node_modules/
}

sha512sums="513a7bc21850d5b6c8741557c09d85a5ed5569c0d66ab52d2f9bc0397bfd99448c37aacd120fc08e8bb7342b4ce5447336c23914a9fc800c97754faf13d5e61a  node-v8.4.0.tar.gz
ba95f21b1e80717ef63941854e7ed412f64a91da068c0dbf0d6d9697333ee266c9f4cd7bf1a01111eeb28aa66adefd8a58cfb3e82debb84b43e35e9dc914dd36  dont-run-gyp-files-for-bundled-deps.patch"
