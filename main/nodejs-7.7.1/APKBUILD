# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Ed Robinson <ed@reevoo.com>
_name=nodejs
pkgver=7.7.1
pkgname="$_name$pkgver"
pkgrel=0
pkgdesc="JavaScript runtime built on V8 engine - current stable version"
url="http://nodejs.org/"
arch="all"
license="MIT"
depends="ca-certificates"
depends_dev="libuv"
# gold is needed for mksnapshot
makedepends="$depends_dev python2 openssl-dev zlib-dev libuv-dev linux-headers
  paxmark binutils-gold http-parser-dev ca-certificates procps"
subpackages="$pkgname-dev $pkgname-doc"
replaces="nodejs nodejs-lts"  # nodejs-lts for backward compatibility
source="https://nodejs.org/dist/v$pkgver/node-v$pkgver.tar.gz
  use-system-ca-certs.patch"
builddir="$srcdir/node-v$pkgver"

prepare() {
  default_prepare || return 1

  # Remove bundled CA certificates.
  rm -f src/node_root_certs.h
  # Remove failing test.
  rm -f test/parallel/test-process-getgroups.js
}

build() {
  cd "$builddir"

  ./configure --prefix=/usr \
    --shared-zlib \
    --shared-libuv \
    --shared-openssl \
    --shared-http-parser \
    || return 1

  # we need run mksnapshot at build time so paxmark it early
  make -C out mksnapshot BUILDTYPE=Release \
    && paxmark -m out/Release/mksnapshot \
    && make || return 1
  make test || return 1
}

package() {
  cd "$builddir"

  make DESTDIR="$pkgdir" install || return 1
  # paxmark so JIT works
  paxmark -m "$pkgdir"/usr/bin/node || return 1

  cp -pr "$pkgdir"/usr/lib/node_modules/npm/man "$pkgdir"/usr/share || return 1
  local d; for d in doc html man; do
    rm -r "$pkgdir"/usr/lib/node_modules/npm/$d || return 1
  done
}

md5sums="559b29d57a5ad2bc04129d5f39b3ce5b  node-v7.7.1.tar.gz
391dadece3caea603003e022d90ba87b  use-system-ca-certs.patch"
sha256sums="9e87ec5420d558ca9651d13b10dd4a1be954fea0fc7a909016a1cc4aedfa651c  node-v7.7.1.tar.gz
dad9470333c07df46bcb46823ce6bf6d606b4146cf9996ef847c458befde8219  use-system-ca-certs.patch"
sha512sums="d6d46247b2eaa327dbbead2f929beeba09930fe9aef350fc7dc7ec976dc1dbdbeae41074cdd3c2f6671ebe4a8a086b0491f97d0af38bda1506cea2eaa23b348a  node-v7.7.1.tar.gz
5c2c4863d5b38ca0bbd81aa8ff5e721cfd3d8c07fef463e34324c5dbd2d15a0d4d966084629c196f94b10c7e17c5527c3eb490c0789b07f1edff013812957a22  use-system-ca-certs.patch"
