# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Ed Robinson <ed@reevoo.com>
_name=nodejs
pkgver=7.7.1
pkgname="$_name$pkgver"
pkgrel=1
pkgdesc="JavaScript runtime built on V8 engine - current stable version"
url="http://nodejs.org/"
arch="all"
license="MIT"
depends="ca-certificates"
depends_dev="libuv"
# gold is needed for mksnapshot
makedepends="$depends_dev python2 openssl-dev zlib-dev libuv-dev linux-headers
  paxmark binutils-gold http-parser-dev ca-certificates procps"
subpackages="$pkgname-dev $pkgname-doc $pkgname-npm"
provides="nodejs"
replaces="nodejs nodejs-current"
source="https://nodejs.org/dist/v$pkgver/node-v$pkgver.tar.gz
  dont-run-gyp-files-for-bundled-deps.patch"
builddir="$srcdir/node-v$pkgver"

prepare() {
  default_prepare || return 1

  # Remove bundled dependencies that we're not using.
  rm -rf deps/http_parser deps/openssl deps/uv deps/zlib
}

build() {
  cd "$builddir"

  ./configure --prefix=/usr \
    --shared-zlib \
    --shared-libuv \
    --shared-openssl \
    --shared-http-parser \
    --openssl-use-def-ca-store \
    || return 1

  # we need run mksnapshot at build time so paxmark it early
  make -C out mksnapshot BUILDTYPE=Release \
    && paxmark -m out/Release/mksnapshot \
    && make || return 1
}

package() {
  cd "$builddir"

  make DESTDIR="$pkgdir" install || return 1
  # paxmark so JIT works
  paxmark -m "$pkgdir"/usr/bin/node || return 1

  cp -pr "$pkgdir"/usr/lib/node_modules/npm/man "$pkgdir"/usr/share || return 1
  local d; for d in doc html man; do
    rm -r "$pkgdir"/usr/lib/node_modules/npm/$d || return 1
  done
}

npm() {
        pkgdesc="a JavaScript package manager"
        depends="$pkgname"
        mkdir -p "$subpkgdir"/usr/bin
        mv "$pkgdir"/usr/bin/npm "$subpkgdir"/usr/bin/npm
        mkdir -p "$subpkgdir"/usr/lib/node_modules
        mv "$pkgdir"/usr/lib/node_modules/npm "$subpkgdir"/usr/lib/node_modules/
}

md5sums="559b29d57a5ad2bc04129d5f39b3ce5b  node-v7.7.1.tar.gz
a8fbdc8d99b89bc657ffd55236027061  dont-run-gyp-files-for-bundled-deps.patch"
sha256sums="9e87ec5420d558ca9651d13b10dd4a1be954fea0fc7a909016a1cc4aedfa651c  node-v7.7.1.tar.gz
57002db8c23490456031ebc287f906294d98ac953a302a7a4d03f05b9628b56b  dont-run-gyp-files-for-bundled-deps.patch"
sha512sums="d6d46247b2eaa327dbbead2f929beeba09930fe9aef350fc7dc7ec976dc1dbdbeae41074cdd3c2f6671ebe4a8a086b0491f97d0af38bda1506cea2eaa23b348a  node-v7.7.1.tar.gz
97d6591ac74eeef761dda64792264ac1f31d2d4dc948009932a32670e4efe9a189124a43f17d2aece76997d118caae5b5c47786fc1f1595ee0d045eba405bdc8  dont-run-gyp-files-for-bundled-deps.patch"
